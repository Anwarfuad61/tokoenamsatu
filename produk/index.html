<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Store",
    "name": "Toko Enam Satu",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Kabupaten Tegal",
      "addressRegion": "Jawa Tengah",
      "addressCountry": "ID"
    },
    "hasOfferCatalog": {
      "@type": "OfferCatalog",
      "name": "Produk Toko Enam Satu",
      "itemListElement": [
        {
          "@type": "Product",
          "name": "Joran Pancing Fiber",
          "image": "https://tokoenamsatu.com/img/joran.webp",
          "offers": {
            "@type": "Offer",
            "price": "85000",
            "priceCurrency": "IDR",
            "availability": "https://schema.org/InStock"
          }
        },
        {
          "@type": "Product",
          "name": "Cetakan Tahu Kayu",
          "image": "https://tokoenamsatu.com/img/cetakan-tahu.webp",
          "offers": {
            "@type": "Offer",
            "price": "150000",
            "priceCurrency": "IDR",
            "availability": "https://schema.org/InStock"
          }
        },
        {
          "@type": "Product",
          "name": "Layang-Layang Diamond",
          "image": "https://tokoenamsatu.com/img/layangan.webp",
          "offers": {
            "@type": "Offer",
            "price": "25000",
            "priceCurrency": "IDR",
            "availability": "https://schema.org/InStock"
          }
        }
      ]
    }
  }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Katalog Produk | Toko Enam Satu – Kabupaten Tegal</title>
  
  <meta name="description" content="Katalog produk Toko Enam Satu Kabupaten Tegal. Menyediakan alat pancing, alat pembuatan tahu, dan peralatan layang-layang berkualitas dengan harga terjangkau.">
  <meta name="keywords" content="Toko Enam Satu, alat pancing tegal, alat pembuatan tahu tegal, toko alat pancing kabupaten tegal">
  <meta name="author" content="Toko Enam Satu">
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="icon" href="tko.png" type="image/png">
  
  <!-- CSS Files - Gunakan path absolut dari root -->
  <link rel="stylesheet" href="/variables.css">
  <link rel="stylesheet" href="/header.css">
  <link rel="stylesheet" href="./produk.css">
  
  <style>
    /* Fallback styling jika CSS tidak loading */
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
    }
    .loading i {
      font-size: 40px;
      color: #0070f3;
      margin-bottom: 15px;
    }
    .error-message {
      color: #dc2626;
      padding: 20px;
      background: #fee2e2;
      border-radius: 8px;
      margin: 20px;
    }
  </style>
</head>

<body>
  <!-- Header akan dimuat via JavaScript -->
  <div id="site-header"></div>

  <div class="main-title" data-aos="fade-up">
    <h1>Katalog Produk Toko Enam Satu</h1>
    <p>Alat Pancing, Alat Pembuatan Tahu & Layangan • Kabupaten Tegal</p>
  </div>

  <!-- Search Bar -->
  <div class="search-container" data-aos="fade-up">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Cari produk...">
    </div>
  </div>

  <!-- Category Filter -->
  <div class="category-filter" data-aos="fade-up">
    <button onclick="filterCategory('all')" class="active">Semua Produk</button>
    <button onclick="filterCategory('pancing')"><i class="fas fa-fish"></i> Alat Pancing</button>
    <button onclick="filterCategory('tahu')"><i class="fas fa-industry"></i> Alat Tahu</button>
    <button onclick="filterCategory('layangan')"><i class="fas fa-paper-plane"></i> Layangan</button>
  </div>

  <!-- Products Container -->
  <section class="products" data-aos="fade-up" id="products-container">
    <div class="loading" id="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Memuat produk...</p>
    </div>
  </section>

  <!-- WhatsApp CTA -->
  <div class="whatsapp-cta" data-aos="zoom-in">
    <div class="cta-content">
      <i class="fab fa-whatsapp"></i>
      <h3>Butuh Bantuan Memilih Produk?</h3>
      <p>Tim kami siap membantu Anda memilih produk yang tepat sesuai kebutuhan.</p>
      <a href="https://wa.me/6289524173746" class="cta-button">
        <i class="fab fa-whatsapp"></i> Chat Sekarang
      </a>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2026 Toko Enam Satu • Kabupaten Tegal</p>
      <p class="footer-contact">
        <i class="fas fa-phone"></i> 0895-2417-3746 | 
        <i class="fas fa-map-marker-alt"></i> Kabupaten Tegal, Jawa Tengah
      </p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });
  </script>

  <script>
    // Google Sheets URL - Pastikan URL ini benar dan publik
    const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQv3M0rETF_bw4sQOCmuAa4ojA7vWEFxaqkfrFUvO1xP6TraZ9tyk4hthVgkCBNu45vCw00uywHCdrM/pub?output=csv';

    // Load header dengan error handling yang lebih baik
    async function loadHeader() {
      try {
        const response = await fetch('/header.html');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const html = await response.text();
        document.getElementById('site-header').innerHTML = html;
        
        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Initialize after header loaded
        setTimeout(() => {
          if (typeof window.init === 'function') {
            window.init();
          }
        }, 100);
        
      } catch (err) {
        console.error('Error loading header:', err);
        // Fallback header
        document.getElementById('site-header').innerHTML = `
          <header class="header" style="background: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div class="logo" style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
              <a href="/" style="display: flex; align-items: center;">
                <img src="/tko.png" alt="Toko Enam Satu" height="40" onerror="this.src='https://via.placeholder.com/40?text=Logo'">
              </a>
              <nav>
                <a href="/" style="margin: 0 10px; text-decoration: none; color: #333;">Home</a>
                <a href="/produk" style="margin: 0 10px; text-decoration: none; color: #333; font-weight: bold;">Produk</a>
                <a href="/tentang" style="margin: 0 10px; text-decoration: none; color: #333;">Tentang</a>
              </nav>
            </div>
          </header>
        `;
      }
    }

    // Load products dari Google Sheets
    async function loadProducts() {
      const loading = document.getElementById('loading');
      
      try {
        console.log('Mencoba memuat produk dari:', GOOGLE_SHEETS_URL);
        
        const response = await fetch(GOOGLE_SHEETS_URL, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Accept': 'text/csv',
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('CSV berhasil dimuat, panjang:', csvText.length);
        
        if (csvText.length < 10) {
          throw new Error('Data CSV terlalu pendek atau kosong');
        }
        
        const products = parseCSV(csvText);
        displayProducts(products);
        
      } catch (error) {
        console.error('Error detail:', error);
        
        // Tampilkan error ke user
        loading.innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
            <h3>Gagal Memuat Produk</h3>
            <p>${error.message}</p>
            <p style="font-size: 14px; margin-top: 15px;">Silakan refresh halaman atau hubungi admin.</p>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> Refresh Halaman
            </button>
          </div>
        `;
        
        // Load dummy products sebagai fallback
        loadDummyProducts();
      }
    }

    // Parse CSV dengan lebih robust
    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(line => line.trim());
      if (lines.length === 0) return [];
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      const products = [];
      
      for (let i = 1; i < lines.length; i++) {
        try {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Parse CSV dengan quoted fields
          const values = [];
          let currentValue = '';
          let inQuotes = false;
          
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(currentValue.trim().replace(/^"|"$/g, ''));
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          values.push(currentValue.trim().replace(/^"|"$/g, '')); // Tambahkan nilai terakhir
          
          if (values.length === headers.length) {
            const product = {};
            headers.forEach((header, index) => {
              product[header] = values[index] || '';
            });
            
            // Filter hanya produk active
            if (product.status && product.status.toLowerCase() === 'active') {
              product.stock = parseInt(product.stock) || 0;
              products.push(product);
            }
          }
        } catch (e) {
          console.warn('Error parsing line', i, e);
        }
      }
      
      console.log('Produk terparse:', products.length);
      return products;
    }

    // Display products dengan image handling yang lebih baik
    function displayProducts(products) {
      const container = document.getElementById('products-container');
      const loading = document.getElementById('loading');
      
      if (!products || products.length === 0) {
        loading.innerHTML = `
          <div style="text-align: center; padding: 50px;">
            <i class="fas fa-box-open" style="font-size: 48px; color: #9ca3af; margin-bottom: 15px;"></i>
            <p>Belum ada produk tersedia.</p>
          </div>
        `;
        return;
      }
      
      loading.style.display = 'none';
      
      let html = '';
      products.forEach(product => {
        // Handle image URL dengan lebih baik
        let imageSrc = getImageUrl(product.image);
        
        // Category display name
        let categoryName = 'Produk';
        if (product.category === 'pancing') categoryName = 'Alat Pancing';
        else if (product.category === 'tahu') categoryName = 'Alat Tahu';
        else if (product.category === 'layangan') categoryName = 'Peralatan Layang-Layang';
        
        html += `
          <div class="product-card" data-category="${product.category}">
            <div class="product-image">
              <img src="${imageSrc}" alt="${product.name}" loading="lazy" 
                   onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=No+Image'">
              <span class="product-category">${categoryName}</span>
            </div>
            <div class="product-info">
              <h3>${product.name}</h3>
              <p class="product-desc">${product.description || ''}</p>
              <div class="product-price">
                <span class="price">Rp ${parseInt(product.price || 0).toLocaleString('id-ID')}</span>
                <span class="stock">
                  <i class="fas fa-${product.stock > 0 ? 'check-circle' : 'times-circle'}"></i>
                  ${product.stock > 0 ? 'Tersedia' : 'Habis'}
                </span>
              </div>
              <div class="product-actions">
                <a class="buy-button" href="https://wa.me/6289524173746?text=Halo,%20saya%20tertarik%20dengan%20${encodeURIComponent(product.name)}" target="_blank">
                  <i class="fab fa-whatsapp"></i> Pesan via WhatsApp
                </a>
                <a class="shopee-button" href="https://shopee.co.id/tokoenamsatu" target="_blank">
                  <i class="fab fa-shopify"></i> Beli di Shopee
                </a>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML += html;
    }

    // Helper function untuk mendapatkan URL gambar
    function getImageUrl(image) {
      if (!image) return 'https://via.placeholder.com/300x200?text=No+Image';
      
      // Google Drive URL
      if (image.includes('drive.google.com')) {
        const fileId = extractGoogleDriveId(image);
        if (fileId) {
          return `https://lh3.googleusercontent.com/d/${fileId}`;
        }
      }
      
      // URL sudah lengkap
      if (image.startsWith('http://') || image.startsWith('https://')) {
        return image;
      }
      
      // File lokal - gunakan path absolut dari root
      if (image.startsWith('/')) {
        return image;
      }
      
      return `/img/${image}`;
    }

    // Extract Google Drive ID dari berbagai format URL
    function extractGoogleDriveId(url) {
      const patterns = [
        /\/file\/d\/([^\/]+)/,
        /[?&]id=([^&]+)/,
        /\/d\/([^\/]+)/,
        /drive\.google\.com\/.*id=([^&]+)/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
      }
      
      return null;
    }

    // Dummy products sebagai fallback
    function loadDummyProducts() {
      const dummyProducts = [
        {
          name: 'Joran Pancing Fiber',
          description: 'Joran pancing berkualitas, kuat dan ringan',
          price: '85000',
          stock: 10,
          category: 'pancing',
          status: 'active',
          image: 'https://via.placeholder.com/300x200?text=Joran+Pancing'
        },
        {
          name: 'Cetakan Tahu Kayu',
          description: 'Cetakan tahu dari kayu jati, awet dan tidak mudah lapuk',
          price: '150000',
          stock: 5,
          category: 'tahu',
          status: 'active',
          image: 'https://via.placeholder.com/300x200?text=Cetakan+Tahu'
        },
        {
          name: 'Layang-Layang Diamond',
          description: 'Layang-layang motif diamond, mudah diterbangkan',
          price: '25000',
          stock: 20,
          category: 'layangan',
          status: 'active',
          image: 'https://via.placeholder.com/300x200?text=Layangan'
        }
      ];
      
      displayProducts(dummyProducts);
    }

    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const keyword = this.value.toLowerCase().trim();
          const productCards = document.querySelectorAll('.product-card');
          
          productCards.forEach(card => {
            const title = card.querySelector('h3')?.textContent.toLowerCase() || '';
            const desc = card.querySelector('.product-desc')?.textContent.toLowerCase() || '';
            const category = card.querySelector('.product-category')?.textContent.toLowerCase() || '';
            
            if (keyword === '' || title.includes(keyword) || desc.includes(keyword) || category.includes(keyword)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          });
        });
      }
    });

    // Filter category
    window.filterCategory = function(category) {
      const productCards = document.querySelectorAll('.product-card');
      const filterButtons = document.querySelectorAll('.category-filter button');
      
      // Update active button
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Filter products
      productCards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
      
      // Reset search
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.value = '';
    };

    // Initialize semua fungsi
    window.addEventListener('load', function() {
      loadHeader();
      loadProducts();
      
      // Set active navigation setelah header dimuat
      setTimeout(() => {
        const navLinks = document.querySelectorAll('.nav-desktop a, .mobile-menu a');
        navLinks.forEach(link => {
          if (link.getAttribute('href') === '/produk' || link.getAttribute('href') === 'produk.html') {
            link.classList.add('active');
          }
        });
      }, 500);
    });
  </script>

  <!-- Load global.js jika ada -->
  <script src="/global.js?v=1.2"></script>
</body>
</html>