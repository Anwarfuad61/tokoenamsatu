<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Toko Enam Satu</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css"> <!-- Link ke file CSS -->
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-cogs"></i> Admin Toko Enam Satu - Cloud Upload</h1>
        
        <!-- API Status -->
        <div class="api-status">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Mengecek koneksi...</span>
        </div>
        
<div class="tabs">
    <div class="tab active" onclick="switchTab('add', this)">Tambah Produk</div>
    <div class="tab" onclick="switchTab('upload', this)">Upload Gambar</div>
    <div class="tab" onclick="switchTab('gallery', this)">Gallery</div>
    <div class="tab" onclick="switchTab('categories', this)">Kategori</div>
    <div class="tab" onclick="switchTab('manage', this)">Kelola Produk</div>
    <div class="tab" onclick="switchTab('logs', this)">Logs & Status</div>
    <div class="tab" onclick="switchTab('settings', this)">Pengaturan</div>
</div>
        <!-- Tab 1: Tambah Produk -->
        <div id="tab-add" class="tab-content active">
            <h2><i class="fas fa-plus-circle"></i> Tambah Produk Baru</h2>
            
            <div class="form-group">
                <label for="productName">Nama Produk *</label>
                <input type="text" id="productName" placeholder="Contoh: Joran Pancing Fiber">
            </div>
            
            <div class="form-group">
                <label for="productPrice">Harga (Rp) *</label>
                <input type="number" id="productPrice" placeholder="Contoh: 85000">
            </div>
            
            <div class="form-group">
                <label for="productCategory">Kategori *</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="productCategory" style="flex: 1;">
                        <option value="">Pilih kategori</option>
                    </select>
                    <button class="btn btn-info" onclick="switchTab('categories')" style="white-space: nowrap;">
                        <i class="fas fa-plus"></i> Kategori Baru
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="productStock">Stok *</label>
                <input type="number" id="productStock" placeholder="Contoh: 15">
            </div>
            
            <div class="form-group">
                <label for="productImage">URL Gambar *</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="productImage" placeholder="URL gambar dari Google Drive atau imgBB" style="flex: 1;">
                    <button class="btn btn-secondary" onclick="switchTab('upload');" style="white-space: nowrap;">
                        <i class="fas fa-upload"></i> Upload Baru
                    </button>
                </div>
                <small>URL gambar dari Google Drive atau imgBB</small>
                <div id="urlConversionPreview"></div>
            </div>
            
            <div class="form-group">
                <label for="productDesc">Deskripsi Produk *</label>
                <textarea id="productDesc" placeholder="Deskripsi lengkap produk..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="productFeatures">Fitur (pisahkan dengan koma)</label>
                <input type="text" id="productFeatures" placeholder="Contoh: Fiber kuat, Ringan, Tahan air">
            </div>
            
            <button class="btn" id="addProductBtn" onclick="addProduct()">
                <i class="fas fa-plus"></i> Tambah Produk ke Google Sheets
            </button>
            
            <div class="progress-bar">
                <div class="progress" id="uploadProgress"></div>
            </div>
            
            <div class="message loading" id="loadingMessage">
                <i class="fas fa-spinner fa-spin"></i> Mengirim data ke Google Sheets...
            </div>
            
            <div class="message success" id="successMessage">
                <i class="fas fa-check-circle"></i> Produk berhasil ditambahkan ke Google Sheets!
            </div>
            
            <div class="message error" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>
        </div>
        
        <!-- Tab 2: Kelola Produk -->
<div id="tab-manage" class="tab-content">
    <h2><i class="fas fa-boxes"></i> Kelola Produk</h2>
    
    <!-- Search & Filter -->
    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
        <div style="flex: 2; min-width: 300px;">
            <input type="text" id="searchProducts" placeholder="Cari produk..." 
                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"
                   onkeyup="searchProductTable()">
        </div>
        <div style="flex: 1; min-width: 200px;">
            <select id="filterCategory" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"
                    onchange="filterProductsByCategory()">
                <option value="">Semua Kategori</option>
            </select>
        </div>
        <div>
            <button class="btn btn-success" onclick="loadProductsFromGoogleSheets()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
    
    <!-- Product Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
            <div style="font-size: 24px; font-weight: bold;" id="totalProducts">0</div>
            <div>Total Produk</div>
        </div>
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px;">
            <div style="font-size: 24px; font-weight: bold;" id="activeProducts">0</div>
            <div>Produk Aktif</div>
        </div>
        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 10px;">
            <div style="font-size: 24px; font-weight: bold;" id="outOfStock">0</div>
            <div>Stok Habis</div>
        </div>
        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 10px;">
            <div style="font-size: 24px; font-weight: bold;" id="totalValue">0</div>
            <div>Total Nilai</div>
        </div>
    </div>
    
    <!-- Products Table -->
    <div style="overflow-x: auto;">
        <table id="productsTable" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background: #f3f4f6;">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">No</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nama Produk</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Kategori</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Harga</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Stok</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Status</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; width: 150px;">Aksi</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <!-- Produk akan dimuat di sini -->
                <tr>
                    <td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">
                        <i class="fas fa-box-open" style="font-size: 48px; opacity: 0.5; margin-bottom: 15px;"></i>
                        <h3>Belum ada data produk</h3>
                        <p>Klik "Refresh" untuk memuat data dari Google Sheets</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <div>
            <span id="pageInfo">Halaman 1 dari 1</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="changePage(-1)" disabled id="prevPageBtn">
                <i class="fas fa-chevron-left"></i> Sebelumnya
            </button>
            <button class="btn btn-secondary" onclick="changePage(1)" disabled id="nextPageBtn">
                Selanjutnya <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Edit Product Modal (Hidden) -->
    <div id="editProductModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px; color: #4f46e5;">
                <i class="fas fa-edit"></i> Edit Produk
            </h2>
            
            <div class="form-group">
                <label for="editProductName">Nama Produk *</label>
                <input type="text" id="editProductName" placeholder="Nama produk">
            </div>
            
            <div class="form-group">
                <label for="editProductPrice">Harga (Rp) *</label>
                <input type="number" id="editProductPrice" placeholder="Harga">
            </div>
            
            <div class="form-group">
                <label for="editProductCategory">Kategori *</label>
                <select id="editProductCategory">
                    <option value="">Pilih kategori</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editProductStock">Stok *</label>
                <input type="number" id="editProductStock" placeholder="Stok">
            </div>
            
            <div class="form-group">
                <label for="editProductImage">URL Gambar *</label>
                <input type="text" id="editProductImage" placeholder="URL gambar">
            </div>
            
            <div class="form-group">
                <label for="editProductDesc">Deskripsi Produk *</label>
                <textarea id="editProductDesc" placeholder="Deskripsi" rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editProductFeatures">Fitur (pisahkan dengan koma)</label>
                <input type="text" id="editProductFeatures" placeholder="Fitur produk">
            </div>
            
            <div class="form-group">
                <label for="editProductStatus">Status</label>
                <select id="editProductStatus">
                    <option value="active">Aktif</option>
                    <option value="inactive">Nonaktif</option>
                    <option value="out_of_stock">Stok Habis</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn btn-success" onclick="updateProduct()">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
                <button class="btn btn-secondary" onclick="closeEditModal()">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        </div>
    </div>
</div>
        <!-- Tab 2: Upload Gambar -->
        <div id="tab-upload" class="tab-content">
            <h2><i class="fas fa-cloud-upload-alt"></i> Upload Gambar ke Cloud</h2>
            
            <div class="method-selector">
                <h3><i class="fas fa-cloud"></i> Pilih Tujuan Upload</h3>
                <p>Pilih dimana gambar akan disimpan:</p>
                <div class="method-buttons">
                    <div class="method-btn active" onclick="setUploadMethod('imgbb')" id="imgbbBtn">
                        <i class="fas fa-bolt" style="color: #f59e0b;"></i>
                        <span>imgBB (Rekomendasi)</span>
                        <small style="font-size: 10px; margin-left: 5px;">Cepat & Gratis</small>
                    </div>
                    <div class="method-btn" onclick="setUploadMethod('drive')" id="driveBtn">
                        <i class="fab fa-google-drive" style="color: #4285F4;"></i>
                        <span>Google Drive</span>
                        <small style="font-size: 10px; margin-left: 5px;">Aman & Unlimited</small>
                    </div>
                </div>
                <div id="methodInfo" style="margin-top: 15px; padding: 10px; background: #f0fdf4; border-radius: 8px;">
                    <p><i class="fas fa-info-circle"></i> <strong>imgBB:</strong> Upload langsung, URL otomatis, gratis 500GB/bulan</p>
                </div>
            </div>
            
            <div class="upload-options">
                <button class="btn btn-success" onclick="showFileUpload()" id="fileUploadBtn">
                    <i class="fas fa-upload"></i> Upload dari File
                </button>
                <button class="btn btn-warning" onclick="showCamera()" id="cameraBtn">
                    <i class="fas fa-camera"></i> Ambil Foto
                </button>
            </div>
            
            <!-- File Upload Area -->
            <div id="fileUploadArea" class="upload-section">
                <div class="upload-area" id="dropArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <h3>Seret & Lepas file di sini</h3>
                        <p>Format: JPG, PNG, WEBP (Maks. 5MB)</p>
                        <p id="uploadTargetText">Gambar akan diupload ke imgBB</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="fileName">Nama File (Opsional):</label>
                    <input type="text" id="fileName" placeholder="contoh: joran-pancing-01.jpg">
                    <small>Jika kosong, nama akan dibuat otomatis</small>
                </div>
                
                <div class="image-preview" id="imagePreview">
                    <button class="remove-btn" onclick="removePreview()">×</button>
                    <img id="previewImg" src="" alt="Preview Gambar">
                </div>
                
                <button class="btn btn-success" id="uploadBtn" onclick="uploadImage()" disabled>
                    <i class="fas fa-cloud-upload-alt"></i> <span id="uploadBtnText">Upload ke imgBB</span>
                </button>
            </div>
            
            <!-- Camera Area -->
            <div id="cameraArea" class="upload-section">
                <div class="camera-container" id="cameraContainer">
                    <div id="cameraStatus">
                        <p><i class="fas fa-spinner fa-spin"></i> Mengakses kamera...</p>
                    </div>
                    <video id="cameraVideo" autoplay playsinline></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                    
                    <div class="camera-controls">
                        <button class="btn btn-success" onclick="takePhoto()" id="takePhotoBtn" disabled>
                            <i class="fas fa-camera"></i> Ambil Foto
                        </button>
                        <button class="btn btn-secondary" onclick="stopCamera()">
                            <i class="fas fa-stop"></i> Stop Kamera
                        </button>
                    </div>
                    
                    <div class="image-preview" id="photoPreview">
                        <button class="remove-btn" onclick="removePhotoPreview()">×</button>
                        <img id="photoImg" src="" alt="Preview Foto">
                    </div>
                    
                    <div class="form-group">
                        <label for="photoName">Nama File untuk Foto:</label>
                        <input type="text" id="photoName" placeholder="contoh: produk-foto-01.jpg">
                    </div>
                    
                    <button class="btn btn-success" onclick="uploadPhoto()" id="savePhotoBtn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> <span id="savePhotoBtnText">Upload ke imgBB</span>
                    </button>
                </div>
            </div>
            
            <!-- Upload Status -->
            <div class="message info" id="uploadStatus" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> <span id="uploadStatusText"></span>
            </div>
            
            <div class="message success" id="uploadSuccessMessage" style="display: none;">
                <i class="fas fa-check-circle"></i> <span id="uploadSuccessText"></span>
                <div id="uploadResult" style="margin-top: 10px;"></div>
            </div>
            
            <div class="message error" id="uploadErrorMessage" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> <span id="uploadErrorText"></span>
            </div>
        </div>
        
        <!-- Tab 3: Gallery -->
        <div id="tab-gallery" class="tab-content">
            <h2><i class="fas fa-images"></i> Cloud Gallery</h2>
            
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Info Cloud Upload:</h3>
                <p>Gambar diupload langsung ke cloud storage (imgBB atau Google Drive)</p>
                <p>Setelah upload, URL gambar akan otomatis terisi di form produk</p>
                <p>Gambar tidak disimpan di browser/server lokal</p>
            </div>
            
            <div class="gallery-container" id="galleryContainer">
                <div id="galleryInfo">
                    <!-- Info akan ditampilkan di sini -->
                </div>
            </div>
        </div>
        
        <!-- Tab 4: Kategori -->
        <div id="tab-categories" class="tab-content">
            <h2><i class="fas fa-tags"></i> Manajemen Kategori</h2>
            
            <div class="category-management">
                <h3><i class="fas fa-list"></i> Daftar Kategori</h3>
                <div id="categoryList" class="category-list">
                    <!-- Kategori akan ditampilkan di sini -->
                </div>
                
                <h3><i class="fas fa-plus"></i> Tambah Kategori Baru</h3>
                <div class="add-category-form">
                    <input type="text" id="newCategoryName" placeholder="Nama kategori baru">
                    <input type="text" id="newCategorySlug" placeholder="Slug (huruf kecil, tanpa spasi)">
                    <button class="btn btn-success" onclick="addCategory()">
                        <i class="fas fa-plus"></i> Tambah
                    </button>
                </div>
                <small>Slug akan digunakan di Google Sheets (contoh: "alat-pancing" untuk "Alat Pancing")</small>
            </div>
        </div>
        
        <!-- Tab 5: Logs -->
        <div id="tab-logs" class="tab-content">
            <h2><i class="fas fa-history"></i> Logs & Status Sync</h2>
            
            <button class="btn" onclick="checkConnection()">
                <i class="fas fa-sync-alt"></i> Test Koneksi
            </button>
            <button class="btn btn-secondary" onclick="clearLogs()">
                <i class="fas fa-trash"></i> Clear Logs
            </button>
            
            <div class="log-container" id="logContainer">
                <!-- Logs akan muncul di sini -->
            </div>
            
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Status Terakhir:</h3>
                <div id="lastSyncStatus"></div>
            </div>
        </div>
        
        <!-- Tab 6: Settings -->
        <div id="tab-settings" class="tab-content">
            <h2><i class="fas fa-cog"></i> Pengaturan API</h2>
            
            <div class="form-group">
                <label for="apiUrl">Google Apps Script URL *</label>
                <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <small>URL Web App dari Google Apps Script untuk produk</small>
            </div>
            
            <div class="form-group">
                <label for="imgbbApiKey">imgBB API Key</label>
                <input type="text" id="imgbbApiKey" value="5f67dedc2d905fb1e250af0eee1a5f89" readonly>
                <small>API Key untuk upload ke imgBB (jangan bagikan)</small>
            </div>
            
            <div class="form-group">
                <label for="driveScriptUrl">Google Apps Script untuk Drive</label>
                <input type="text" id="driveScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <small>URL Web App untuk upload ke Google Drive (opsional)</small>
            </div>
            
            <button class="btn btn-success" onclick="saveSettings()">
                <i class="fas fa-save"></i> Simpan Pengaturan
            </button>
        </div>
    </div>
    
    <script>
        // ============ KONFIGURASI ============
        const CONFIG = {
            IMGBB_API_KEY: '5f67dedc2d905fb1e250af0eee1a5f89',
        };
        
        let logs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
        let categories = JSON.parse(localStorage.getItem('categories') || '[]');
        let currentImageFile = null;
        let cameraStream = null;
        let uploadMethod = 'imgbb'; // 'imgbb' atau 'drive'
        let products = []; // Untuk menyimpan data produk
        let currentProducts = null; // Menyimpan semua produk yang dimuat
        let currentEditProduct = null; // Untuk menyimpan produk yang sedang diedit
        
        // ============ HELPER FUNCTIONS ============
        async function getAPIUrl() {
            const configUrl = localStorage.getItem('apiUrl') || '';
            if (configUrl && configUrl.includes('script.google.com')) {
                return configUrl;
            }
            // Fallback ke URL default jika tidak ada yang valid
            return "https://script.google.com/macros/s/AKfycbx-w9tYNFSdXOBD0Dx1KJgYG-_qgbHZ83uNq9KFpgV6QP-lGKNMGXX4DcbYiiQxYptBQg/exec";
        }
        
        function getDriveScriptUrl() {
            return localStorage.getItem('driveScriptUrl') || '';
        }
        
        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            checkConnection();
            renderLogs();
            updateLastSync();
            initUploadListeners();
            loadGallery();
            loadCategories();
            showFileUpload();
            setUploadMethod('imgbb');
            
            // Auto load products when on manage tab
            const manageTab = document.querySelector('.tab[onclick="switchTab(\'manage\')"]');
            if (manageTab) {
                manageTab.addEventListener('click', function() {
                    setTimeout(() => {
                        loadProductsFromGoogleSheets();
                    }, 500);
                });
            }
            
            // Load initial categories if empty
            if (categories.length === 0) {
                categories = [
                    { id: 'pancing', name: 'Alat Pancing', slug: 'pancing' },
                    { id: 'tahu', name: 'Alat Pembuatan Tahu', slug: 'tahu' }
                ];
                localStorage.setItem('categories', JSON.stringify(categories));
                updateCategoryDropdown();
            }
        });
        
        // ============ UPLOAD METHOD SELECTOR ============
        function setUploadMethod(method) {
            uploadMethod = method;
            
            // Update UI
            document.getElementById('imgbbBtn').classList.remove('active');
            document.getElementById('driveBtn').classList.remove('active');
            document.getElementById(method + 'Btn').classList.add('active');
            
            // Update button texts
            const uploadBtn = document.getElementById('uploadBtn');
            const savePhotoBtn = document.getElementById('savePhotoBtn');
            const uploadTargetText = document.getElementById('uploadTargetText');
            const methodInfo = document.getElementById('methodInfo');
            
            if (method === 'imgbb') {
                uploadBtn.innerHTML = '<i class="fas fa-bolt"></i> Upload ke imgBB';
                if (savePhotoBtn) savePhotoBtn.innerHTML = '<i class="fas fa-bolt"></i> Upload ke imgBB';
                uploadTargetText.textContent = 'Gambar akan diupload ke imgBB (Cepat & Gratis)';
                methodInfo.innerHTML = '<p><i class="fas fa-info-circle"></i> <strong>imgBB:</strong> Upload langsung, URL otomatis, gratis 500GB/bulan</p>';
            } else {
                uploadBtn.innerHTML = '<i class="fab fa-google-drive"></i> Upload ke Google Drive';
                if (savePhotoBtn) savePhotoBtn.innerHTML = '<i class="fab fa-google-drive"></i> Upload ke Google Drive';
                uploadTargetText.textContent = 'Gambar akan diupload ke Google Drive Anda';
                methodInfo.innerHTML = '<p><i class="fas fa-info-circle"></i> <strong>Google Drive:</strong> Aman, unlimited storage, perlu setup Apps Script</p>';
            }
            
            showMessage('info', `Metode upload diubah ke: ${method === 'imgbb' ? 'imgBB' : 'Google Drive'}`);
        }
        
        // ============ UPLOAD FUNCTIONS ============
        function uploadImage() {
            const fileName = document.getElementById('fileName').value.trim() || 
                            `gambar_${Date.now()}.${currentImageFile.type.split('/')[1] || 'jpg'}`;
            
            if (uploadMethod === 'imgbb') {
                uploadToImgBB(currentImageFile, fileName);
            } else {
                uploadToGoogleDrive(currentImageFile, fileName);
            }
        }
        
        function uploadPhoto() {
            const fileName = document.getElementById('photoName').value.trim() || 
                            `foto_${Date.now()}.jpg`;
            
            if (uploadMethod === 'imgbb') {
                uploadToImgBB(currentImageFile, fileName);
            } else {
                uploadToGoogleDrive(currentImageFile, fileName);
            }
        }
        
        // ============ UPLOAD KE IMGBB ============
        async function uploadToImgBB(file, fileName) {
            showUploadStatus('Upload ke imgBB...');
            
            try {
                // Konversi file ke Base64
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    
                    // Buat FormData
                    const formData = new FormData();
                    formData.append('image', base64Data);
                    formData.append('name', fileName);
                    
                    // Upload ke imgBB
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // URL gambar
                        const imageUrl = data.data.url;
                        const thumbnailUrl = data.data.thumb.url;
                        
                        // Auto-fill image field
                        document.getElementById('productImage').value = imageUrl;
                        
                        // Tampilkan hasil
                        const resultDiv = document.getElementById('uploadResult');
                        resultDiv.innerHTML = `
                            <div style="margin: 15px 0;">
                                <img src="${thumbnailUrl}" style="max-width: 200px; border-radius: 8px; border: 2px solid #ddd;">
                            </div>
                            <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin: 10px 0;">
                                <p><strong>URL Gambar:</strong></p>
                                <input type="text" value="${imageUrl}" readonly 
                                       style="width: 100%; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;"
                                       onclick="this.select()">
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn" onclick="copyToClipboard('${imageUrl}')" style="flex: 1;">
                                    <i class="fas fa-copy"></i> Copy URL
                                </button>
                                <button class="btn btn-success" onclick="switchTab('add')" style="flex: 1;">
                                    <i class="fas fa-check"></i> Gunakan di Produk
                                </button>
                            </div>
                        `;
                        
                        showUploadSuccess(`Gambar berhasil diupload ke imgBB!`);
                        addLog(`Gambar diupload ke imgBB: ${fileName} -> ${imageUrl}`, 'success');
                        
                        // Reset form
                        removePreview();
                        removePhotoPreview();
                        document.getElementById('fileName').value = '';
                        document.getElementById('photoName').value = '';
                        document.getElementById('uploadBtn').disabled = true;
                        document.getElementById('savePhotoBtn').disabled = true;
                        
                    } else {
                        showUploadError(`Gagal upload: ${data.error.message}`);
                    }
                };
                
                reader.onerror = function(error) {
                    showUploadError(`Error membaca file: ${error}`);
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                showUploadError(`Error: ${error.message}`);
            }
        }
        
        // ============ UPLOAD KE GOOGLE DRIVE ============
        async function uploadToGoogleDrive(file, fileName) {
            showUploadStatus('Mempersiapkan upload ke Google Drive...');
            
            try {
                const driveScriptUrl = getDriveScriptUrl();
                if (!driveScriptUrl) {
                    // Jika tidak ada script URL, tampilkan instruksi manual
                    showUploadSuccess(`
                        <h4><i class="fab fa-google-drive"></i> Upload ke Google Drive</h4>
                        <p>Untuk upload otomatis ke Google Drive, Anda perlu:</p>
                        <ol style="text-align: left; margin-left: 20px;">
                            <li>Buat Google Apps Script untuk upload</li>
                            <li>Deploy sebagai Web App</li>
                            <li>Masukkan URL di Pengaturan</li>
                        </ol>
                        <div style="margin: 20px 0;">
                            <button class="btn" onclick="copyScriptCode()">
                                <i class="fas fa-copy"></i> Copy Script Code
                            </button>
                        </div>
                        <p><strong>Atau upload manual:</strong></p>
                        <ol style="text-align: left; margin-left: 20px;">
                            <li>Buka <a href="https://drive.google.com" target="_blank">Google Drive</a></li>
                            <li>Upload file ini</li>
                            <li>Set permissions ke "Anyone with the link"</li>
                            <li>Copy link dan paste di form produk</li>
                        </ol>
                    `);
                    
                    addLog(`Instruksi Google Drive untuk: ${fileName}`, 'info');
                    return;
                }
                
                // Konversi file ke Base64
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    
                    // Data untuk dikirim ke Apps Script
                    const uploadData = {
                        action: 'uploadImage',
                        filename: fileName,
                        mimeType: file.type,
                        imageData: base64Data,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Kirim ke Apps Script
                    const response = await fetch(driveScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(uploadData)
                    });
                    
                    // Karena no-cors, kita asumsikan berhasil
                    setTimeout(() => {
                        showUploadSuccess(`
                            <h4><i class="fab fa-google-drive"></i> Upload Diproses</h4>
                            <p>File: <strong>${fileName}</strong></p>
                            <p>Ukuran: ${(file.size / 1024).toFixed(2)} KB</p>
                            <p>Upload sedang diproses ke Google Drive...</p>
                            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <p>SUKSES UPLOAD FILE: ${fileName}</p>
                            </div>
                        `);
                        
                        addLog(`Upload ke Google Drive diproses: ${fileName}`, 'info');
                        
                        // Reset form
                        removePreview();
                        removePhotoPreview();
                        document.getElementById('fileName').value = '';
                        document.getElementById('photoName').value = '';
                        document.getElementById('uploadBtn').disabled = true;
                        document.getElementById('savePhotoBtn').disabled = true;
                        
                    }, 2000);
                    
                };
                
                reader.onerror = function(error) {
                    showUploadError(`Error membaca file: ${error}`);
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                showUploadError(`Error: ${error.message}`);
            }
        }
        
        // ============ HELPER FUNCTIONS ============
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('success', 'URL berhasil disalin ke clipboard!');
            });
        }
        
        // ============ TAB SWITCHING ============
        // ============ TAB SWITCHING - PERBAIKAN ============
// ============ TAB SWITCHING - VERSION PALING STABIL ============
function switchTab(tabName, clickedElement) {
    console.log('Switching to tab:', tabName);
    
    // 1. HAPUS class active dari semua tab
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // 2. HAPUS class active dari semua tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // 3. AKTIFKAN tab yang diklik
    if (clickedElement) {
        // Jika element diberikan langsung
        clickedElement.classList.add('active');
    } else {
        // Fallback: cari tab berdasarkan teks
        const tabs = document.querySelectorAll('.tab');
        for (let tab of tabs) {
            if (tab.textContent.toLowerCase().includes(tabName)) {
                tab.classList.add('active');
                break;
            }
        }
    }
    
    // 4. TAMPILKAN konten tab yang sesuai
    const tabContent = document.getElementById('tab-' + tabName);
    if (tabContent) {
        tabContent.classList.add('active');
        console.log('Tab content ditemukan:', 'tab-' + tabName);
    } else {
        console.error('Tab content tidak ditemukan:', 'tab-' + tabName);
    }
    
    // 5. PANGGIL fungsi spesifik berdasarkan tab
    setTimeout(() => {
        if (tabName === 'gallery') {
            if (typeof loadGallery === 'function') loadGallery();
        } 
        else if (tabName === 'categories') {
            if (typeof renderCategories === 'function') renderCategories();
        } 
        else if (tabName === 'manage') {
            if (typeof loadProductsFromGoogleSheets === 'function') {
                loadProductsFromGoogleSheets();
            }
        }
        else if (tabName === 'upload') {
            if (typeof showFileUpload === 'function') showFileUpload();
        }
        else if (tabName === 'logs') {
            if (typeof renderLogs === 'function') renderLogs();
            if (typeof updateLastSync === 'function') updateLastSync();
        }
        else if (tabName === 'settings') {
            if (typeof loadSettings === 'function') loadSettings();
        }
        // 'add' tidak perlu action khusus
    }, 100);
}
        
        // ============ KATEGORI FUNCTIONS ============
        function loadCategories() {
            updateCategoryDropdown();
            renderCategories();
        }
        
        function updateCategoryDropdown() {
            const select = document.getElementById('productCategory');
            const editSelect = document.getElementById('editProductCategory');
            
            select.innerHTML = '<option value="">Pilih kategori</option>';
            editSelect.innerHTML = '<option value="">Pilih kategori</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.slug;
                option.textContent = category.name;
                select.appendChild(option);
                
                const editOption = document.createElement('option');
                editOption.value = category.slug;
                editOption.textContent = category.name;
                editSelect.appendChild(editOption);
            });
        }
        
        function renderCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            
            if (categories.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">Belum ada kategori. Tambah kategori baru.</p>';
                return;
            }
            
            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'category-tag';
                tag.innerHTML = `
                    ${category.name}
                    <button onclick="deleteCategory('${category.id}')">×</button>
                `;
                container.appendChild(tag);
            });
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            let slug = document.getElementById('newCategorySlug').value.trim();
            
            if (!name) {
                showError('Nama kategori harus diisi');
                return;
            }
            
            if (!slug) {
                // Generate slug from name
                slug = name.toLowerCase()
                    .replace(/[^a-z0-9]/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '');
            }
            
            // Check if slug already exists
            if (categories.some(cat => cat.slug === slug)) {
                showError('Slug sudah digunakan');
                return;
            }
            
            const category = {
                id: Date.now().toString(),
                name: name,
                slug: slug,
                created: new Date().toISOString()
            };
            
            categories.push(category);
            localStorage.setItem('categories', JSON.stringify(categories));
            
            updateCategoryDropdown();
            renderCategories();
            
            // Clear form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategorySlug').value = '';
            
            showMessage('success', `Kategori "${name}" berhasil ditambahkan`);
            addLog(`Kategori ditambahkan: ${name}`, 'success');
        }
        
        function deleteCategory(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus kategori ini?')) {
                return;
            }
            
            const categoryIndex = categories.findIndex(cat => cat.id === id);
            if (categoryIndex !== -1) {
                const categoryName = categories[categoryIndex].name;
                categories.splice(categoryIndex, 1);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                updateCategoryDropdown();
                renderCategories();
                
                showMessage('success', `Kategori "${categoryName}" berhasil dihapus`);
                addLog(`Kategori dihapus: ${categoryName}`, 'warning');
            }
        }
        
        // ============ UPLOAD GAMBAR FUNCTIONS ============
        function initUploadListeners() {
            // File input change
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            
            // Drag and drop
            const dropArea = document.getElementById('dropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('dragover');
            }
            
            function unhighlight() {
                dropArea.classList.remove('dragover');
            }
            
            dropArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }
        
        function showFileUpload() {
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('cameraArea').style.display = 'none';
            document.getElementById('fileUploadBtn').classList.add('active');
            document.getElementById('cameraBtn').classList.remove('active');
            stopCamera();
        }
        
        function showCamera() {
            document.getElementById('fileUploadArea').style.display = 'none';
            document.getElementById('cameraArea').style.display = 'block';
            document.getElementById('cameraBtn').classList.add('active');
            document.getElementById('fileUploadBtn').classList.remove('active');
            startCamera();
        }
        
        function handleFileSelect(file) {
            if (!file.type.match('image.*')) {
                showUploadError('File harus berupa gambar (JPG, PNG, WEBP)');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showUploadError('Ukuran file maksimal 5MB');
                return;
            }
            
            currentImageFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false;
                
                // Suggest filename
                const originalName = file.name.replace(/\.[^/.]+$/, "");
                const cleanName = originalName
                    .toLowerCase()
                    .replace(/[^a-z0-9]/g, '-')
                    .replace(/-+/g, '-')
                    .substring(0, 50);
                const extension = file.name.split('.').pop().toLowerCase();
                document.getElementById('fileName').value = `${cleanName}-${Date.now()}.${extension}`;
            };
            reader.readAsDataURL(file);
        }
        
        function removePreview() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadBtn').disabled = true;
            currentImageFile = null;
        }
        
        // ============ KAMERA FUNCTIONS ============
        async function startCamera() {
            try {
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                document.getElementById('takePhotoBtn').disabled = false;
                document.getElementById('cameraStatus').innerHTML = '<p><i class="fas fa-check-circle"></i> Kamera siap digunakan</p>';
                
            } catch (error) {
                document.getElementById('cameraStatus').innerHTML = `
                    <p style="color: #ef4444;">
                        <i class="fas fa-exclamation-circle"></i> 
                        Gagal mengakses kamera: ${error.message}
                    </p>
                    <p>Pastikan izin kamera diberikan pada browser</p>
                `;
                document.getElementById('takePhotoBtn').disabled = true;
            }
        }
        
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                document.getElementById('cameraVideo').srcObject = null;
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('savePhotoBtn').disabled = true;
            }
        }
        
        function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to blob
            canvas.toBlob(function(blob) {
                currentImageFile = new File([blob], 'photo.jpg', { 
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                // Show preview
                const photoUrl = URL.createObjectURL(blob);
                document.getElementById('photoImg').src = photoUrl;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('savePhotoBtn').disabled = false;
                
                // Suggest filename
                const timestamp = new Date().getTime();
                document.getElementById('photoName').value = `foto-produk-${timestamp}.jpg`;
                
            }, 'image/jpeg', 0.8);
        }
        
        function removePhotoPreview() {
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('savePhotoBtn').disabled = true;
            currentImageFile = null;
        }
        
        // ============ GALLERY FUNCTIONS ============
        function loadGallery() {
            const info = document.getElementById('galleryInfo');
            
            info.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; opacity: 0.5;"></i>
                    <h3 style="margin: 15px 0;">Cloud Upload System</h3>
                    <p>Gambar diupload langsung ke cloud storage</p>
                    <p>Tidak disimpan di browser/server lokal</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: left;">
                            <h4 style="margin-bottom: 15px;"><i class="fas fa-bolt"></i> imgBB</h4>
                            <ul style="padding-left: 20px;">
                                <li>Upload langsung tanpa backend</li>
                                <li>API Key: ${CONFIG.IMGBB_API_KEY.substring(0, 10)}...</li>
                                <li>Gratis 500GB/bulan</li>
                                <li>CDN cepat global</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); color: white; padding: 25px; border-radius: 15px; text-align: left;">
                            <h4 style="margin-bottom: 15px;"><i class="fab fa-google-drive"></i> Google Drive</h4>
                            <ul style="padding-left: 20px;">
                                <li>Aman & terpercaya</li>
                                <li>Unlimited storage</li>
                                <li>Perlu setup Apps Script</li>
                                <li>URL format khusus</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; background: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h4>📊 Statistik Upload</h4>
                        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4f46e5;">2</div>
                                <div style="font-size: 12px;">Metode Upload</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #10b981;">5MB</div>
                                <div style="font-size: 12px;">Max File Size</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">500GB</div>
                                <div style="font-size: 12px;">Free Storage</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('galleryContainer').style.display = 'block';
        }
        
        // ============ UPLOAD UI HELPERS ============
        function showUploadStatus(message) {
            document.getElementById('uploadStatusText').textContent = message;
            document.getElementById('uploadStatus').style.display = 'block';
            document.getElementById('uploadSuccessMessage').style.display = 'none';
            document.getElementById('uploadErrorMessage').style.display = 'none';
        }
        
        function showUploadSuccess(message) {
            document.getElementById('uploadSuccessText').textContent = message;
            document.getElementById('uploadSuccessMessage').style.display = 'block';
            document.getElementById('uploadStatus').style.display = 'none';
            document.getElementById('uploadErrorMessage').style.display = 'none';
        }
        
        function showUploadError(message) {
            document.getElementById('uploadErrorText').textContent = message;
            document.getElementById('uploadErrorMessage').style.display = 'block';
            document.getElementById('uploadStatus').style.display = 'none';
            document.getElementById('uploadSuccessMessage').style.display = 'none';
        }
        
        // ============ PRODUK & SETTINGS FUNCTIONS ============
        function loadSettings() {
            document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || '';
            document.getElementById('imgbbApiKey').value = CONFIG.IMGBB_API_KEY;
            document.getElementById('driveScriptUrl').value = localStorage.getItem('driveScriptUrl') || '';
        }
        
        function saveSettings() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const driveScriptUrl = document.getElementById('driveScriptUrl').value.trim();
            
            if (apiUrl && !apiUrl.includes('https://script.google.com/')) {
                showError('URL harus dari Google Apps Script');
                return;
            }
            
            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('driveScriptUrl', driveScriptUrl);
            
            addLog('Pengaturan disimpan', 'info');
            checkConnection();
            showMessage('success', 'Pengaturan berhasil disimpan');
        }
        
        async function checkConnection() {
            try {
                const API_URL = await getAPIUrl();
                
                if (!API_URL) {
                    updateStatus('disconnected', 'URL API belum diatur');
                    return;
                }
                
                updateStatus('connecting', 'Mengecek koneksi...');
                
                const response = await fetch(API_URL);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.message || Array.isArray(data)) {
                        updateStatus('connected', 'Terhubung ke Google Sheets API');
                        addLog('Koneksi berhasil', 'success');
                    } else {
                        updateStatus('disconnected', 'Format respon tidak dikenali');
                    }
                } else {
                    updateStatus('disconnected', `Error ${response.status}`);
                }
                
            } catch (error) {
                updateStatus('disconnected', `Error: ${error.message}`);
                addLog(`Koneksi gagal: ${error.message}`, 'error');
            }
        }
        
        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            indicator.classList.add(`status-${status}`);
            
            text.textContent = message;
        }
        
        // ============ LOAD PRODUCTS ============
        async function loadProductsFromGoogleSheets() {
            try {
                const API_URL = await getAPIUrl();
                showMessage('loading', 'Memuat data produk...');
                
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Pastikan data adalah array
                if (Array.isArray(data)) {
                    currentProducts = data;
                    renderProductsTable(data);
                    updateProductStats(data);
                    updateCategoryFilter(data);
                    showMessage('success', `Berhasil memuat ${data.length} produk`);
                } else {
                    throw new Error('Format data tidak valid');
                }
                
            } catch (error) {
                showMessage('error', `Gagal memuat produk: ${error.message}`);
                console.error('Error loading products:', error);
            }
        }
        
        function renderProductsTable(products) {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            if (!products || products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">
                            <i class="fas fa-box-open" style="font-size: 48px; opacity: 0.5; margin-bottom: 15px;"></i>
                            <h3>Belum ada data produk</h3>
                            <p>Tambahkan produk baru di tab "Tambah Produk"</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px 15px;">${index + 1}</td>
                    <td style="padding: 12px 15px;">
                        <strong>${product.name || 'Tidak ada nama'}</strong>
                        ${product.description ? `<br><small>${product.description.substring(0, 50)}...</small>` : ''}
                    </td>
                    <td style="padding: 12px 15px;">${product.category || '-'}</td>
                    <td style="padding: 12px 15px;">Rp ${Number(product.price || 0).toLocaleString()}</td>
                    <td style="padding: 12px 15px;">
                        <span class="status-badge ${getStockClass(product.stock)}">
                            ${product.stock || 0}
                        </span>
                    </td>
                    <td style="padding: 12px 15px;">
                        <span class="status-badge status-${product.status || 'active'}">
                            ${getStatusText(product.status)}
                        </span>
                    </td>
                    <td style="padding: 12px 15px;">
                        <div class="action-buttons">
                            <button class="action-btn btn-edit" onclick="editProduct('${product.id || index}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteProduct('${product.id || index}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update statistics
            updateProductStats(products);
        }
        
        function getStockClass(stock) {
            stock = parseInt(stock) || 0;
            if (stock > 10) return 'status-active';
            if (stock > 0) return 'status-warning';
            return 'status-out_of_stock';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'active': 'Aktif',
                'inactive': 'Nonaktif',
                'out_of_stock': 'Stok Habis'
            };
            return statusMap[status] || 'Aktif';
        }
        
        function updateProductStats(products) {
            if (!products) return;
            
            const totalProducts = products.length;
            const activeProducts = products.filter(p => p.status === 'active').length;
            const outOfStock = products.filter(p => p.status === 'out_of_stock' || (parseInt(p.stock) || 0) <= 0).length;
            const totalValue = products.reduce((sum, p) => sum + (parseInt(p.price) || 0) * (parseInt(p.stock) || 0), 0);
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('activeProducts').textContent = activeProducts;
            document.getElementById('outOfStock').textContent = outOfStock;
            document.getElementById('totalValue').textContent = `Rp ${totalValue.toLocaleString()}`;
        }
        
        function updateCategoryFilter(products) {
            const select = document.getElementById('filterCategory');
            const uniqueCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
            
            select.innerHTML = '<option value="">Semua Kategori</option>';
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
        
        async function deleteProduct(productId) {
            if (!confirm('Yakin hapus produk?')) return;
            
            try {
                const API_URL = await getAPIUrl();
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        id: productId
                    })
                });
                
                showMessage('success', 'Produk berhasil dihapus');
                setTimeout(() => {
                    loadProductsFromGoogleSheets();
                }, 1000);
                
            } catch (error) {
                showMessage('error', `Gagal menghapus: ${error.message}`);
            }
        }
        
        function editProduct(productId) {
            if (!currentProducts) {
                showMessage('error', 'Data produk belum dimuat');
                return;
            }
            
            const product = currentProducts.find(p => p.id == productId || p.row_id == productId);
            if (!product) {
                showMessage('error', 'Produk tidak ditemukan');
                return;
            }
            
            currentEditProduct = product;
            
            // Isi form edit
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductPrice').value = product.price || 0;
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductStock').value = product.stock || 0;
            document.getElementById('editProductImage').value = product.image || '';
            document.getElementById('editProductDesc').value = product.description || '';
            document.getElementById('editProductFeatures').value = product.features || '';
            document.getElementById('editProductStatus').value = product.status || 'active';
            
            // Tampilkan modal
            document.getElementById('editProductModal').style.display = 'flex';
        }
        
        async function updateProduct() {
            if (!currentEditProduct) return;
            
            const updatedData = {
                action: 'update',
                id: currentEditProduct.id || currentEditProduct.row_id,
                name: document.getElementById('editProductName').value.trim(),
                price: parseInt(document.getElementById('editProductPrice').value) || 0,
                category: document.getElementById('editProductCategory').value.trim(),
                stock: parseInt(document.getElementById('editProductStock').value) || 0,
                image: document.getElementById('editProductImage').value.trim(),
                description: document.getElementById('editProductDesc').value.trim(),
                features: document.getElementById('editProductFeatures').value.trim(),
                status: document.getElementById('editProductStatus').value
            };
            
            try {
                const API_URL = await getAPIUrl();
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });
                
                showMessage('success', 'Produk berhasil diperbarui');
                closeEditModal();
                
                // Refresh data
                setTimeout(() => {
                    loadProductsFromGoogleSheets();
                }, 1000);
                
            } catch (error) {
                showMessage('error', `Gagal update: ${error.message}`);
            }
        }
        
        function closeEditModal() {
            document.getElementById('editProductModal').style.display = 'none';
            currentEditProduct = null;
        }
        
        // ============ ADD PRODUCT ============
async function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const price = document.getElementById('productPrice').value;
    const category = document.getElementById('productCategory').value;
    const stock = document.getElementById('productStock').value;
    const image = document.getElementById('productImage').value.trim();
    const desc = document.getElementById('productDesc').value.trim();
    const features = document.getElementById('productFeatures').value.trim();
    
    if (!name || !price || !category || !stock || !image || !desc) {
        showError('Harap isi semua field yang wajib!');
        return;
    }
    
    showLoading(true);
    
    // Dapatkan URL API
    let API_URL = await getAPIUrl();
    
    // Data produk
    const productData = {
        id: 'P' + Date.now(),
        name: name,
        price: parseInt(price),
        category: category,
        stock: parseInt(stock),
        image: image,
        description: desc,
        features: features,
        status: 'active'
    };
    
    console.log('Data yang dikirim:', productData);
    
    try {
        // Gunakan JSONP method
        const success = await sendToGoogleSheets(API_URL, productData);
        
        if (success) {
            showSuccess('✅ Produk berhasil ditambahkan ke Google Sheets!');
            addLog(`Produk "${name}" berhasil ditambahkan`, 'success');
            resetForm();
            
            // Refresh data jika di tab manage
            if (document.getElementById('tab-manage').classList.contains('active')) {
                setTimeout(() => loadProductsFromGoogleSheets(), 2000);
            }
        } else {
            throw new Error('Gagal mengirim data');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showError(`❌ Gagal: ${error.message}`);
        addLog(`Gagal menambah produk: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

// Fungsi baru untuk mengirim ke Google Sheets
async function sendToGoogleSheets(apiUrl, data) {
    return new Promise((resolve, reject) => {
        // Method 1: Coba dengan fetch biasa
        fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data).toString()
        })
        .then(() => {
            // Dengan no-cors, kita anggap berhasil
            // Tapi kita verifikasi dengan getProducts
            setTimeout(async () => {
                try {
                    const checkResponse = await fetch(apiUrl);
                    if (checkResponse.ok) {
                        resolve(true);
                    } else {
                        // Method 2: Coba dengan iframe (fallback)
                        sendViaIframe(apiUrl, data, resolve, reject);
                    }
                } catch (e) {
                    sendViaIframe(apiUrl, data, resolve, reject);
                }
            }, 2000);
        })
        .catch(() => {
            sendViaIframe(apiUrl, data, resolve, reject);
        });
    });
}

// Fallback: Kirim via iframe tersembunyi
function sendViaIframe(apiUrl, data, resolve, reject) {
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = apiUrl;
    form.target = iframe.name = 'iframe_' + Date.now();
    
    // Tambahkan semua data sebagai input
    Object.keys(data).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = data[key];
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    
    // Timer untuk response
    const timeout = setTimeout(() => {
        document.body.removeChild(form);
        document.body.removeChild(iframe);
        resolve(true); // Anggap berhasil
    }, 5000);
    
    form.submit();
    
    // Cleanup
    setTimeout(() => {
        clearTimeout(timeout);
        if (document.body.contains(form)) document.body.removeChild(form);
        if (document.body.contains(iframe)) document.body.removeChild(iframe);
    }, 6000);
}

// Fungsi untuk memuat produk
async function loadProductsFromGoogleSheets() {
    try {
        const API_URL = await getAPIUrl();
        showMessage('loading', 'Memuat data produk...');
        
        // Gunakan JSONP untuk menghindari CORS
        const response = await fetch(API_URL + '?action=getProducts&_=' + Date.now());
        
        if (response.ok) {
            const data = await response.json();
            
            if (Array.isArray(data)) {
                currentProducts = data;
                renderProductsTable(data);
                updateProductStats(data);
                updateCategoryFilter(data);
                showMessage('success', `Berhasil memuat ${data.length} produk`);
            } else {
                // Coba fetch tanpa action
                const fallbackResponse = await fetch(API_URL);
                const fallbackData = await fallbackResponse.json();
                if (Array.isArray(fallbackData)) {
                    currentProducts = fallbackData;
                    renderProductsTable(fallbackData);
                    updateProductStats(fallbackData);
                    updateCategoryFilter(fallbackData);
                    showMessage('success', `Berhasil memuat ${fallbackData.length} produk`);
                } else {
                    throw new Error('Format data tidak valid');
                }
            }
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
    } catch (error) {
        console.error('Error loading products:', error);
        showMessage('error', `Gagal memuat produk: ${error.message}`);
    }
}
// Fungsi untuk test koneksi yang lebih baik
async function testConnection() {
    try {
        const API_URL = await getAPIUrl();
        showMessage('loading', 'Menguji koneksi ke Google Sheets...');
        
        // Test dengan GET
        const response = await fetch(API_URL + '?action=test&_=' + Date.now());
        
        if (response.ok) {
            const data = await response.json();
            console.log('Test response:', data);
            
            if (data.success || data.message) {
                showMessage('success', '✅ Koneksi berhasil!');
                updateStatus('connected', 'Terhubung');
                addLog('Test koneksi berhasil', 'success');
                return true;
            }
        }
        
        // Coba tanpa parameter
        const fallbackResponse = await fetch(API_URL);
        if (fallbackResponse.ok) {
            showMessage('success', '✅ Koneksi berhasil (mode dasar)');
            updateStatus('connected', 'Terhubung');
            addLog('Test koneksi berhasil', 'success');
            return true;
        }
        
        throw new Error('Tidak dapat terhubung');
        
    } catch (error) {
        console.error('Connection test failed:', error);
        showMessage('error', `❌ Gagal: ${error.message}`);
        updateStatus('disconnected', 'Gagal terhubung');
        addLog(`Test koneksi gagal: ${error.message}`, 'error');
        return false;
    }
}

// Panggil test saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    // ... kode existing ...
    
    // Test koneksi setelah 1 detik
    setTimeout(() => {
        testConnection();
    }, 1000);
});
// FUNGSI FETCH DENGAN RETRY
async function fetchWithRetry(url, data, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            console.log(`Attempt ${i + 1} to fetch ${url}`);
            
            // Method 1: Gunakan JSONP-style untuk menghindari CORS
            const jsonpUrl = `${url}?callback=handleResponse&data=${encodeURIComponent(JSON.stringify(data))}`;
            
            // Method 2: Gunakan Google Apps Script redirect
            const formData = new URLSearchParams();
            Object.keys(data).forEach(key => {
                formData.append(key, data[key]);
            });
            
            // Coba dengan method POST biasa dulu
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', // No-cros untuk Google Apps Script
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString()
            });
            
            // Karena no-cors, kita tidak bisa membaca response
            // Asumsikan berhasil setelah 2 detik
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            return { success: true, message: 'Data terkirim (mode no-cors)' };
            
        } catch (error) {
            console.log(`Attempt ${i + 1} failed:`, error.message);
            
            if (i === retries - 1) {
                throw error;
            }
            
            // Tunggu sebelum retry
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
    }
}
        
        function showLoading(show) {
            const btn = document.getElementById('addProductBtn');
            const loading = document.getElementById('loadingMessage');
            const progress = document.getElementById('uploadProgress');
            
            if (show) {
                btn.disabled = true;
                loading.style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                
                let width = 0;
                const interval = setInterval(() => {
                    if (width >= 100) {
                        clearInterval(interval);
                        progress.style.width = '0%';
                    } else {
                        width += 10;
                        progress.style.width = width + '%';
                    }
                }, 200);
                
            } else {
                btn.disabled = false;
                loading.style.display = 'none';
                progress.style.width = '0%';
            }
        }
        
        function showSuccess(message) {
            const success = document.getElementById('successMessage');
            success.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            success.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function showError(message) {
            const error = document.getElementById('errorMessage');
            error.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            error.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showMessage(type, text) {
            const message = document.getElementById('successMessage');
            message.innerHTML = `<i class="fas fa-info-circle"></i> ${text}`;
            message.className = `message ${type}`;
            message.style.display = 'block';
            setTimeout(() => { message.style.display = 'none'; }, 3000);
        }
        
        function resetForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('productDesc').value = '';
            document.getElementById('productFeatures').value = '';
        }
        
        // ============ LOGS FUNCTIONS ============
        function addLog(message, type = 'info') {
            const log = {
                timestamp: new Date().toLocaleTimeString('id-ID'),
                message: message,
                type: type
            };
            
            logs.unshift(log);
            if (logs.length > 50) logs.pop();
            
            localStorage.setItem('syncLogs', JSON.stringify(logs));
            renderLogs();
        }
        
        function renderLogs() {
            const container = document.getElementById('logContainer');
            let html = '';
            
            logs.forEach(log => {
                html += `
                    <div class="log-entry">
                        <span class="log-time">[${log.timestamp}]</span>
                        <span class="log-${log.type}"> ${log.message}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="log-entry">Belum ada logs</div>';
        }
        
        function clearLogs() {
            logs = [];
            localStorage.removeItem('syncLogs');
            renderLogs();
            addLog('Logs telah dibersihkan', 'info');
        }
        
        function updateLastSync() {
            const lastSync = document.getElementById('lastSyncStatus');
            const lastLog = logs.find(log => log.type === 'success' && log.message.includes('Produk'));
            
            if (lastLog) {
                lastSync.innerHTML = `
                    <p><strong>Terakhir sukses:</strong> ${lastLog.timestamp}</p>
                    <p><strong>Pesan:</strong> ${lastLog.message}</p>
                `;
            } else {
                lastSync.innerHTML = '<p>Belum ada sync yang sukses</p>';
            }
        }
        
        // ============ SEARCH AND FILTER ============
        function searchProductTable() {
            const input = document.getElementById('searchProducts').value.toLowerCase();
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(input) ? '' : 'none';
            });
        }
        
        function filterProductsByCategory() {
            const selectedCategory = document.getElementById('filterCategory').value;
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const categoryCell = row.cells[2]; // Kolom kategori
                if (!categoryCell) return;
                
                const category = categoryCell.textContent.trim();
                if (!selectedCategory || category === selectedCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // ============ SCRIPT CODE ============
        function copyScriptCode() {
            const code = `// Google Apps Script untuk Upload ke Google Drive
const FOLDER_ID = 'YOUR_GOOGLE_DRIVE_FOLDER_ID';

function doPost(e) {
    try {
        const data = JSON.parse(e.postData.contents);
        
        if (data.action === 'uploadImage') {
            // Decode base64 image
            const imageBytes = Utilities.base64Decode(data.imageData);
            const blob = Utilities.newBlob(imageBytes, data.mimeType, data.filename);
            
            // Upload ke Google Drive
            let folder;
            if (FOLDER_ID) {
                folder = DriveApp.getFolderById(FOLDER_ID);
            } else {
                folder = DriveApp.getRootFolder();
            }
            
            const file = folder.createFile(blob);
            
            // Set permissions to public
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
            
            // Generate direct URL
            const fileId = file.getId();
            const directUrl = \`https://drive.google.com/uc?export=view&id=\${fileId}\`;
            
            return ContentService
                .createTextOutput(JSON.stringify({
                    success: true,
                    message: 'File uploaded successfully',
                    fileId: fileId,
                    directUrl: directUrl,
                    filename: data.filename
                }))
                .setMimeType(ContentService.MimeType.JSON);
        }
        
        return ContentService
            .createTextOutput(JSON.stringify({
                success: false,
                message: 'Action not supported'
            }))
            .setMimeType(ContentService.MimeType.JSON);
            
    } catch (error) {
        return ContentService
            .createTextOutput(JSON.stringify({
                success: false,
                error: error.toString()
            }))
            .setMimeType(ContentService.MimeType.JSON);
    }
}

function doGet() {
    return ContentService
        .createTextOutput(JSON.stringify({
            message: 'Google Drive Upload API',
            endpoints: { uploadImage: 'POST dengan JSON' }
        }))
        .setMimeType(ContentService.MimeType.JSON);
}`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('Kode Google Apps Script telah disalin ke clipboard!');
                addLog('Google Apps Script code copied', 'info');
            });
        }
    </script>
</body>
</html>